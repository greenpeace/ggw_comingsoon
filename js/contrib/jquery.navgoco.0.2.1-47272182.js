$(function(){"use strict";var Plugin=function(el,options,idx){return this.el=el,this.$el=$(el),this.options=options,this.uuid=this.$el.attr("id")?this.$el.attr("id"):idx,this.state={},this.init(),this};Plugin.prototype={init:function(){var self=this;self._load(),self.$el.find("ul").each(function(idx){var sub=$(this);sub.attr("data-index",idx),self.options.save&&self.state.hasOwnProperty(idx)?(sub.parent().addClass(self.options.openClass),sub.show()):sub.parent().hasClass(self.options.openClass)?(sub.show(),self.state[idx]=1):sub.hide()});var caret=$("<span></span>").prepend(self.options.caretHtml),links=self.$el.find("li > a");self._trigger(caret,!1),self._trigger(links,!0),self.$el.find("li:has(ul) > a").prepend(caret)},_trigger:function(sources,isLink){var self=this;sources.on("click",function(event){event.stopPropagation();var sub=isLink?$(this).next():$(this).parent().next(),isAnchor=!1;if(isLink){var href=$(this).attr("href");isAnchor=void 0===href||""===href||"#"===href}if(sub=sub.length>0?sub:!1,self.options.onClickBefore.call(this,event,sub),!isLink||sub&&isAnchor)event.preventDefault(),self._toggle(sub,sub.is(":hidden")),self._save();else if(self.options.accordion){var allowed=self.state=self._parents($(this));self.$el.find("ul").filter(":visible").each(function(){var sub=$(this),idx=sub.attr("data-index");allowed.hasOwnProperty(idx)||self._toggle(sub,!1)}),self._save()}self.options.onClickAfter.call(this,event,sub)})},_toggle:function(sub,open){var self=this,idx=sub.attr("data-index"),parent=sub.parent();if(self.options.onToggleBefore.call(this,sub,open),open){if(parent.addClass(self.options.openClass),sub.slideDown(self.options.slide),self.state[idx]=1,self.options.accordion){var allowed=self.state=self._parents(sub);allowed[idx]=self.state[idx]=1,self.$el.find("ul").filter(":visible").each(function(){var sub=$(this),idx=sub.attr("data-index");allowed.hasOwnProperty(idx)||self._toggle(sub,!1)})}}else parent.removeClass(self.options.openClass),sub.slideUp(self.options.slide),self.state[idx]=0;self.options.onToggleAfter.call(this,sub,open)},_parents:function(sub,obj){var result={},parent=sub.parent(),parents=parent.parents("ul");return parents.each(function(){var par=$(this),idx=par.attr("data-index");return idx?void(result[idx]=obj?par:1):!1}),result},_save:function(){if(this.options.save){var save={};for(var key in this.state)1===this.state[key]&&(save[key]=1);cookie[this.uuid]=this.state=save,$.cookie(this.options.cookie.name,JSON.stringify(cookie),this.options.cookie)}},_load:function(){if(this.options.save){if(null===cookie){var data=$.cookie(this.options.cookie.name);cookie=data?JSON.parse(data):{}}this.state=cookie.hasOwnProperty(this.uuid)?cookie[this.uuid]:{}}},toggle:function(open){var self=this,length=arguments.length;if(1>=length)self.$el.find("ul").each(function(){var sub=$(this);self._toggle(sub,open)});else{var idx,list={},args=Array.prototype.slice.call(arguments,1);length--;for(var i=0;length>i;i++){idx=args[i];var sub=self.$el.find('ul[data-index="'+idx+'"]').first();if(sub&&(list[idx]=sub,open)){var parents=self._parents(sub,!0);for(var pIdx in parents)list.hasOwnProperty(pIdx)||(list[pIdx]=parents[pIdx])}}for(idx in list)self._toggle(list[idx],open)}self._save()},destroy:function(){$.removeData(this.$el),this.$el.find("li:has(ul) > a").unbind("click"),this.$el.find("li:has(ul) > a > span").unbind("click")}},$.fn.navgoco=function(options){if("string"==typeof options&&"_"!==options.charAt(0)&&"init"!==options)var callback=!0,args=Array.prototype.slice.call(arguments,1);else options=$.extend({},$.fn.navgoco.defaults,options||{}),$.cookie||(options.save=!1);return this.each(function(idx){var $this=$(this),obj=$this.data("navgoco");obj||(obj=new Plugin(this,callback?$.fn.navgoco.defaults:options,idx),$this.data("navgoco",obj)),callback&&obj[options].apply(obj,args)})};var cookie=null;$.fn.navgoco.defaults={caretHtml:"",accordion:!1,openClass:"open",save:!0,cookie:{name:"navgoco",expires:!1,path:"/"},slide:{duration:400,easing:"swing"},onClickBefore:$.noop,onClickAfter:$.noop,onToggleBefore:$.noop,onToggleAfter:$.noop}});