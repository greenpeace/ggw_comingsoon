(function(){L.Control.Search=L.Control.extend({includes:L.Mixin.Events,options:{wrapper:"",url:"",jsonpParam:null,layer:null,callData:null,propertyName:"title",propertyLoc:"loc",callTip:null,filterJSON:null,minLength:1,initial:!0,autoType:!0,delayType:400,tooltipLimit:-1,tipAutoSubmit:!0,autoResize:!0,collapsed:!0,autoCollapse:!1,autoCollapseTime:1200,zoom:null,text:"Search...",textCancel:"Cancel",textErr:"Location not found",position:"topleft",animateLocation:!0,circleLocation:!0,markerLocation:!1,markerIcon:new L.Icon.Default},initialize:function(options){L.Util.setOptions(this,options||{}),this._inputMinSize=this.options.text?this.options.text.length:10,this._layer=this.options.layer||new L.LayerGroup,this._filterJSON=this.options.filterJSON||this._defaultFilterJSON,this._autoTypeTmp=this.options.autoType,this._countertips=0,this._recordsCache={},this._curReq=null},onAdd:function(map){return this._map=map,this._container=L.DomUtil.create("div","leaflet-control-search"),this._input=this._createInput(this.options.text,"search-input"),this._tooltip=this._createTooltip("search-tooltip"),this._cancel=this._createCancel(this.options.textCancel,"search-cancel"),this._button=this._createButton(this.options.text,"search-button"),this._alert=this._createAlert("search-alert"),this.options.collapsed===!1&&this.expand(),(this.options.circleLocation||this.options.markerLocation||this.options.markerIcon)&&(this._markerLoc=new SearchMarker([0,0],{showCircle:this.options.circleLocation,showMarker:this.options.markerLocation,icon:this.options.markerIcon})),this.setLayer(this._layer),map.on({resize:this._handleAutoresize},this),this._container},addTo:function(map){return this.options.wrapper?(this._container=this.onAdd(map),this._wrapper=L.DomUtil.get(this.options.wrapper),this._wrapper.style.position="relative",this._wrapper.appendChild(this._container)):L.Control.prototype.addTo.call(this,map),this},onRemove:function(){this._recordsCache={}},_getPath:function(obj,prop){var parts=prop.split("."),last=parts.pop(),len=parts.length,cur=parts[0],i=1;if(len>0)for(;(obj=obj[cur])&&len>i;)cur=parts[i++];return obj?obj[last]:void 0},setLayer:function(layer){return this._layer=layer,this._layer.addTo(this._map),this._markerLoc&&this._layer.addLayer(this._markerLoc),this},showAlert:function(text){text=text||this.options.textErr,this._alert.style.display="block",this._alert.innerHTML=text,clearTimeout(this.timerAlert);var that=this;return this.timerAlert=setTimeout(function(){that.hideAlert()},this.options.autoCollapseTime),this},hideAlert:function(){return this._alert.style.display="none",this},cancel:function(){return this._input.value="",this._handleKeypress({keyCode:8}),this._input.size=this._inputMinSize,this._input.focus(),this._cancel.style.display="none",this},expand:function(){return this._input.style.display="block",L.DomUtil.addClass(this._container,"search-exp"),this._input.focus(),this._map.on("dragstart click",this.collapse,this),this},collapse:function(){return this._hideTooltip(),this.cancel(),this._alert.style.display="none",this._input.blur(),this.options.collapsed&&(this._input.style.display="none",this._cancel.style.display="none",L.DomUtil.removeClass(this._container,"search-exp"),this._map.off("dragstart click",this.collapse,this)),this.fire("search_collapsed"),this},collapseDelayed:function(){if(!this.options.autoCollapse)return this;var that=this;return clearTimeout(this.timerCollapse),this.timerCollapse=setTimeout(function(){that.collapse()},this.options.autoCollapseTime),this},collapseDelayedStop:function(){return clearTimeout(this.timerCollapse),this},_createAlert:function(className){var alert=L.DomUtil.create("div",className,this._container);return alert.style.display="none",L.DomEvent.on(alert,"click",L.DomEvent.stop,this).on(alert,"click",this.hideAlert,this),alert},_createInput:function(text,className){var input=L.DomUtil.create("input",className,this._container);return input.type="text",input.size=this._inputMinSize,input.value="",input.autocomplete="off",input.autocorrect="off",input.autocapitalize="off",input.placeholder=text,input.style.display="none",L.DomEvent.disableClickPropagation(input).on(input,"keyup",this._handleKeypress,this).on(input,"keydown",this._handleAutoresize,this).on(input,"blur",this.collapseDelayed,this).on(input,"focus",this.collapseDelayedStop,this),input},_createCancel:function(title,className){var cancel=L.DomUtil.create("a",className,this._container);return cancel.href="#",cancel.title=title,cancel.style.display="none",cancel.innerHTML="<span>&otimes;</span>",L.DomEvent.on(cancel,"click",L.DomEvent.stop,this).on(cancel,"click",this.cancel,this),cancel},_createButton:function(title,className){var button=L.DomUtil.create("a",className,this._container);return button.href="#",button.title=title,L.DomEvent.on(button,"click",L.DomEvent.stop,this).on(button,"click",this._handleSubmit,this).on(button,"focus",this.collapseDelayedStop,this).on(button,"blur",this.collapseDelayed,this),button},_createTooltip:function(className){var tool=L.DomUtil.create("div",className,this._container);tool.style.display="none";var that=this;return L.DomEvent.disableClickPropagation(tool).on(tool,"blur",this.collapseDelayed,this).on(tool,"mousewheel",function(e){that.collapseDelayedStop(),L.DomEvent.stopPropagation(e)},this).on(tool,"mouseover",function(){that.collapseDelayedStop()},this),tool},_createTip:function(text,val){var tip;if(this.options.callTip){if(tip=this.options.callTip(text,val),"string"==typeof tip){var tmpNode=L.DomUtil.create("div");tmpNode.innerHTML=tip,tip=tmpNode.firstChild}}else tip=L.DomUtil.create("a",""),tip.href="#",tip.innerHTML=text;return L.DomUtil.addClass(tip,"search-tip"),tip._text=text,L.DomEvent.disableClickPropagation(tip).on(tip,"click",L.DomEvent.stop,this).on(tip,"click",function(){this._input.value=text,this._handleAutoresize(),this._input.focus(),this._hideTooltip(),this.options.tipAutoSubmit&&this._handleSubmit()},this),tip},_filterRecords:function(text){var I,regSearch,regFilter=new RegExp("^[.]$|[[]|()*]","g"),frecords={};text=text.replace(regFilter,""),I=this.options.initial?"^":"",regSearch=new RegExp(I+text,"i");for(var key in this._recordsCache)regSearch.test(key)&&(frecords[key]=this._recordsCache[key]);return frecords},showTooltip:function(){var filteredRecords,newTip;this._countertips=0,filteredRecords=this.options.layer?this._filterRecords(this._input.value):this._recordsCache,this._tooltip.innerHTML="",this._tooltip.currentSelection=-1;for(var key in filteredRecords){if(++this._countertips==this.options.tooltipLimit)break;newTip=this._createTip(key,filteredRecords[key]),this._tooltip.appendChild(newTip)}return this._countertips>0?(this._tooltip.style.display="block",this._autoTypeTmp&&this._autoType(),this._autoTypeTmp=this.options.autoType):this._hideTooltip(),this._tooltip.scrollTop=0,this._countertips},_hideTooltip:function(){return this._tooltip.style.display="none",this._tooltip.innerHTML="",0},_defaultFilterJSON:function(json){var i,jsonret={},propName=this.options.propertyName,propLoc=this.options.propertyLoc;if(L.Util.isArray(propLoc))for(i in json)jsonret[this._getPath(json[i],propName)]=L.latLng(json[i][propLoc[0]],json[i][propLoc[1]]);else for(i in json)jsonret[this._getPath(json[i],propName)]=L.latLng(this._getPath(json[i],propLoc));return jsonret},_recordsFromJsonp:function(text,callAfter){var that=this;L.Control.Search.callJsonp=function(data){var fdata=that._filterJSON(data);callAfter(fdata)};var script=L.DomUtil.create("script","search-jsonp",document.getElementsByTagName("body")[0]),url=L.Util.template(this.options.url+"&"+this.options.jsonpParam+"=L.Control.Search.callJsonp",{s:text});return script.type="text/javascript",script.src=url,{abort:function(){script.parentNode.removeChild(script)}}},_recordsFromAjax:function(text,callAfter){void 0===window.XMLHttpRequest&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(e1){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(e2){throw new Error("XMLHttpRequest is not supported")}}});var request=new XMLHttpRequest,url=L.Util.template(this.options.url,{s:text}),response={};request.open("GET",url);var that=this;return request.onreadystatechange=function(){if(4===request.readyState&&200===request.status){response=JSON.parse(request.responseText);var fdata=that._filterJSON(response);callAfter(fdata)}},request.send(),request},_recordsFromLayer:function(){var loc,that=this,retRecords={},propName=this.options.propertyName;return this._layer.eachLayer(function(layer){layer instanceof SearchMarker||(layer instanceof L.Marker||L.CircleMarker?that._getPath(layer.options,propName)?(loc=layer.getLatLng(),loc.layer=layer,retRecords[that._getPath(layer.options,propName)]=loc):that._getPath(layer.feature.properties,propName)?(loc=layer.getLatLng(),loc.layer=layer,retRecords[that._getPath(layer.feature.properties,propName)]=loc):console.log("propertyName '"+propName+"' not found in marker",layer):layer.hasOwnProperty("feature")&&(layer.feature.properties.hasOwnProperty(propName)?(loc=layer.getBounds().getCenter(),loc.layer=layer,retRecords[layer.feature.properties[propName]]=loc):console.log("propertyName '"+propName+"' not found in feature",layer)))},this),retRecords},_autoType:function(){var start=this._input.value.length,firstRecord=this._tooltip.firstChild._text,end=firstRecord.length;if(0===firstRecord.indexOf(this._input.value))if(this._input.value=firstRecord,this._handleAutoresize(),this._input.createTextRange){var selRange=this._input.createTextRange();selRange.collapse(!0),selRange.moveStart("character",start),selRange.moveEnd("character",end),selRange.select()}else this._input.setSelectionRange?this._input.setSelectionRange(start,end):this._input.selectionStart&&(this._input.selectionStart=start,this._input.selectionEnd=end)},_hideAutoType:function(){var sel;if((sel=this._input.selection)&&sel.empty)sel.empty();else if(this._input.createTextRange){sel=this._input.createTextRange(),sel.collapse(!0);var end=this._input.value.length;sel.moveStart("character",end),sel.moveEnd("character",end),sel.select()}else this._input.getSelection&&this._input.getSelection().removeAllRanges(),this._input.selectionStart=this._input.selectionEnd},_handleKeypress:function(e){switch(e.keyCode){case 27:this.collapse();break;case 13:1==this._countertips&&this._handleArrowSelect(1),this._handleSubmit();break;case 38:this._handleArrowSelect(-1);break;case 40:this._handleArrowSelect(1);break;case 37:case 39:case 16:case 17:break;case 8:case 46:this._autoTypeTmp=!1;break;default:if(this._cancel.style.display=this._input.value.length?"block":"none",this._input.value.length>=this.options.minLength){var that=this;clearTimeout(this.timerKeypress),this.timerKeypress=setTimeout(function(){that._fillRecordsCache()},this.options.delayType)}else this._hideTooltip()}},_fillRecordsCache:function(){var inputText=this._input.value,that=this;this._curReq&&this._curReq.abort&&this._curReq.abort(),L.DomUtil.addClass(this._container,"search-load"),this.options.callData?this._curReq=this.options.callData(inputText,function(jsonraw){that._recordsCache=that._filterJSON(jsonraw),that.showTooltip(),L.DomUtil.removeClass(that._container,"search-load")}):this.options.url?this._curReq=this.options.jsonpParam?this._recordsFromJsonp(inputText,function(data){that._recordsCache=data,that.showTooltip(),L.DomUtil.removeClass(that._container,"search-load")}):this._recordsFromAjax(inputText,function(data){that._recordsCache=data,that.showTooltip(),L.DomUtil.removeClass(that._container,"search-load")}):this.options.layer&&(this._recordsCache=this._recordsFromLayer(),this.showTooltip(),L.DomUtil.removeClass(this._container,"search-load"))},_handleAutoresize:function(){this._input.style.maxWidth!=this._map._container.offsetWidth&&(this._input.style.maxWidth=L.DomUtil.getStyle(this._map._container,"width")),this.options.autoResize&&this._container.offsetWidth+45<this._map._container.offsetWidth&&(this._input.size=this._input.value.length<this._inputMinSize?this._inputMinSize:this._input.value.length)},_handleArrowSelect:function(velocity){var searchTips=this._tooltip.hasChildNodes()?this._tooltip.childNodes:[];for(i=0;i<searchTips.length;i++)L.DomUtil.removeClass(searchTips[i],"search-tip-select");if(1==velocity&&this._tooltip.currentSelection>=searchTips.length-1)L.DomUtil.addClass(searchTips[this._tooltip.currentSelection],"search-tip-select");else if(-1==velocity&&this._tooltip.currentSelection<=0)this._tooltip.currentSelection=-1;else if("none"!=this._tooltip.style.display){this._tooltip.currentSelection+=velocity,L.DomUtil.addClass(searchTips[this._tooltip.currentSelection],"search-tip-select"),this._input.value=searchTips[this._tooltip.currentSelection]._text;var tipOffsetTop=searchTips[this._tooltip.currentSelection].offsetTop;tipOffsetTop+searchTips[this._tooltip.currentSelection].clientHeight>=this._tooltip.scrollTop+this._tooltip.clientHeight?this._tooltip.scrollTop=tipOffsetTop-this._tooltip.clientHeight+searchTips[this._tooltip.currentSelection].clientHeight:tipOffsetTop<=this._tooltip.scrollTop&&(this._tooltip.scrollTop=tipOffsetTop)}},_handleSubmit:function(){if(this._hideAutoType(),this.hideAlert(),this._hideTooltip(),"none"==this._input.style.display)this.expand();else if(""===this._input.value)this.collapse();else{var loc=this._getLocation(this._input.value);loc===!1?this.showAlert():(this.showLocation(loc,this._input.value),this.fire("search_locationfound",{latlng:loc,text:this._input.value,layer:loc.layer?loc.layer:null}))}},_getLocation:function(key){return this._recordsCache.hasOwnProperty(key)?this._recordsCache[key]:!1},showLocation:function(latlng,title){return this.options.zoom?this._map.setView(latlng,this.options.zoom):this._map.panTo(latlng),this._markerLoc&&(this._markerLoc.setLatLng(latlng),this._markerLoc.setTitle(title),this._markerLoc.show(),this.options.animateLocation&&this._markerLoc.animate()),this.options.autoCollapse&&this.collapse(),this}});var SearchMarker=L.Marker.extend({includes:L.Mixin.Events,options:{radius:10,weight:3,color:"#e03",stroke:!0,fill:!1,title:"",icon:new L.Icon.Default,showCircle:!0,showMarker:!1},initialize:function(latlng,options){L.setOptions(this,options),L.Marker.prototype.initialize.call(this,latlng,options),this.options.showCircle&&(this._circleLoc=new L.CircleMarker(latlng,this.options))},onAdd:function(map){L.Marker.prototype.onAdd.call(this,map),this._circleLoc&&map.addLayer(this._circleLoc),this.hide()},onRemove:function(map){L.Marker.prototype.onRemove.call(this,map),this._circleLoc&&map.removeLayer(this._circleLoc)},setLatLng:function(latlng){return L.Marker.prototype.setLatLng.call(this,latlng),this._circleLoc&&this._circleLoc.setLatLng(latlng),this},setTitle:function(title){return title=title||"",this.options.title=title,this._icon&&(this._icon.title=title),this},show:function(){return this.options.showMarker&&(this._icon&&(this._icon.style.display="block"),this._shadow&&(this._shadow.style.display="block")),this._circleLoc&&this._circleLoc.setStyle({fill:this.options.fill,stroke:this.options.stroke}),this},hide:function(){return this._icon&&(this._icon.style.display="none"),this._shadow&&(this._shadow.style.display="none"),this._circleLoc&&this._circleLoc.setStyle({fill:!1,stroke:!1}),this},animate:function(){if(this._circleLoc){var circle=this._circleLoc,tInt=200,ss=10,mr=parseInt(circle._radius/ss),oldrad=this.options.radius,newrad=2.5*circle._radius,acc=0;circle._timerAnimLoc=setInterval(function(){acc+=.5,mr+=acc,newrad-=mr,circle.setRadius(newrad),oldrad>newrad&&(clearInterval(circle._timerAnimLoc),circle.setRadius(oldrad))},tInt)}return this}});L.Map.addInitHook(function(){this.options.searchControl&&(this.searchControl=L.control.search(this.options.searchControl),this.addControl(this.searchControl))}),L.control.search=function(options){return new L.Control.Search(options)}}).call(this);